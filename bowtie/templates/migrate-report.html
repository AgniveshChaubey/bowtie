<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Bowtie â€“</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg sticky-top mb-4">
      <div class="container-fluid">
        <a class="navbar-brand mb-0 h1" href="#">Bowtie</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="#run-info">Run Info</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#summary">Summary</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#cases">Details</a>
            </li>
          </ul>
        </div>
        <button id="theme-toggler" class="btn border-0 me-1"></button>

        <a
          href="https://github.com/bowtie-json-schema/bowtie/"
          class="link-secondary"
        >
          <span class="navbar-text">
            <small id="bowtie-version">Bowtie v - </small>
          </span>
        </a>
      </div>
    </nav>

    <div class="container p-4">
      <div class="card mx-auto mb-3 w-75" id="run-info">
        <div class="card-header">Run Info</div>
        <div class="card-body">
          <table class="table table-sm table-hover">
            <tr>
              <td>Dialect</td>
              <td id="dialect-link"></td>
            </tr>
            <tr>
              <td>Ran</td>
              <td>
                <time id="run-started"></time>
              </td>
            </tr>
          </table>
        </div>
      </div>

      <div class="card mx-auto mb-3 w-75" id="summary">
        <div class="card-header">Summary</div>

        <div class="card-body">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th
                  colspan="2"
                  rowspan="2"
                  scope="col"
                  class="text-center align-middle"
                >
                  implementation
                </th>
                <th colspan="1" class="text-center">
                  <span id="total_cases" class="text-muted">cases</span>
                </th>
                <th colspan="3" class="text-center">
                  <span id="total_tests" class="text-muted">tests</span>
                </th>
                <th colspan="1"></th>
              </tr>

              <tr>
                <th scope="col" class="text-center">errors</th>

                <th scope="col" class="table-bordered text-center">skipped</th>
                <th
                  scope="col"
                  class="table-bordered text-center details-required"
                >
                  <div class="hover-details details-desc text-center"></div>
                  unsuccessful
                </th>

                <th scope="col"></th>
              </tr>
            </thead>

            <tbody id="tbody" class="table-group-divider"></tbody>

            <tfoot>
              <tr>
                <th scope="row" colspan="2">total</th>

                <td id="summary-errored_cases" class="text-center"></td>

                <td id="summary-skipped_tests" class="text-center"></td>
                <td
                  id="summary-total-tests"
                  class="text-center details-required"
                ></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <script type="module" src="../utilclasses.js"></script>
    <script type="module" src="../functions.js"></script>
  
    <!-- ////////////////////// Testing Script //////////////////////////// -->
    <script>
        async function loadFunctions() {
            const module = await import("../functions.js");
            const Calculator = module.Calculator;

            const calculator = new Calculator();
            //console.log(calculator.sum(4, 55));
            //console.log(calculator.greet(4));
        }
      document.addEventListener("DOMContentLoaded", loadFunctions);
    </script>
    <!-- ///////////////////////////////////////////////////////////////// -->

    <script>
      async function jsonData(dataObjectsArray) {
        const module = await import("../utilclasses.js");
        const RunInfo = module.RunInfo;

        let lines = dataObjectsArray.map(line => JSON.parse(line));
        //console.log(lines)
        //console.log(RunInfo)
  
        let data = [1,2,3,4]


        let run_info = new RunInfo(...Object.values(lines[0]));
        //console.log(run_info)
        //console.log(run_info._implementations)
        let summary = run_info.create_summary();
        //console.log(summary)
        //console.log(summary.counts)

        const titleElement = document.querySelector("title");
            titleElement.textContent += ` ${run_info.dialect_shortname}`;

            //adding bowtie version
            var bowtieVersion = document.getElementById("bowtie-version");
            bowtieVersion.textContent += `${run_info.bowtie_version}`;

            //adding dialect link in #run-info
            var dialectLink = document.querySelector("#dialect-link");
            dialectLink.textContent = `${run_info.dialect}`;

            let ago = (Date.now() - Date.parse(`${run_info.started}`)) / 1000;
            let agoUnits = "seconds";
            if (ago > 60) {
              ago /= 60;
              agoUnits = "minutes";
              if (ago > 60) {
                ago /= 60;
                agoUnits = "hours";
                if (ago > 24) {
                  ago /= 24;
                  agoUnits = "days";
                  if (ago > 7) {
                    ago /= 7;
                    agoUnits = "weeks";
                  }
                }
              }
            }
            const roundedAgo = Math.round(ago);
            const formattedAgo = Number.isFinite(roundedAgo)
              ? new Intl.RelativeTimeFormat("en", { numeric: "auto" }).format(
                  -roundedAgo,
                  agoUnits,
                )
              : "";
            document.getElementById("run-started").textContent = formattedAgo;

            //summary section
            var totalCases = document.getElementById("total_cases");
            totalCases.textContent += ` (${summary.total_cases})`;

            var totalTests = document.getElementById("total_tests");
            totalTests.textContent += ` (${summary.total_tests})`;

            //updating summary table
            tbody = document.getElementById("tbody");
            //console.log(typeof(summary.implementations))
            let implementations = summary.implementations;
            //console.log(implementations)
            for (i = 0; i < implementations.length; i++) {
              //th section of summary table's data
              let implementation = implementations[i];
              //console.log(implementation.dialects)
              let counts = summary.counts[implementation.image];
              console.log(counts)

              var tr = document.createElement("tr");
              var th = document.createElement("th");
              th.setAttribute("scope", "row");

            const a = document.createElement("a");
            a.setAttribute(
              "id",
              `implementation-${data.summary.implementation[i].name}`
            );
            a.textContent = `${data.summary.implementation[i].name} `;

            const smallTH = document.createElement("small");
            smallTH.setAttribute(
              "id",
              `implementation-${data.summary.implementation[i].language}`
            );
            smallTH.setAttribute("class", "text-muted");
            smallTH.textContent = `${data.summary.implementation[i].language}`;

            th.appendChild(a);
            th.appendChild(smallTH);
            tr.appendChild(th);
            

            //td section of summary table's data
            var td = document.createElement("td");
            const smallTD = document.createElement("small");
            smallTD.setAttribute("class", "font-monospace text-muted");
            smallTD.textContent = `${data.summary.implementation[i].version}`;

              const buttonTD = document.createElement("button");
              buttonTD.setAttribute("class", "btn border-0");

            const svgTD = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "svg"
            );
            svgTD.setAttribute("width", "16");
            svgTD.setAttribute("height", "16");
            svgTD.setAttribute("fill", "currentColor");
            svgTD.setAttribute("class", "bi bi-info-circle-fill");
            svgTD.setAttribute("viewBox", "0 0 16 16");
            svgTD.setAttribute("data-bs-toggle", "modal");
            svgTD.setAttribute(
              "data-bs-target",
              `#implementation-runtime-info`
            );

            const pathTD = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "path"
            );
            pathTD.setAttribute(
              "d",
              "M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"
            );

              svgTD.appendChild(pathTD);
              buttonTD.appendChild(svgTD);

              var td = document.createElement("td");
              td.appendChild(smallTD);
              td.appendChild(buttonTD);

              tr.appendChild(td);


            //final section of table body
            var td2 = document.createElement('td');
            td2.setAttribute('class', 'text-center');
            td2.textContent = `${data.summary.counts.errored_cases}`;

            var td3 = document.createElement('td');
            td3.setAttribute('class', 'text-center');
            td3.textContent += `${data.summary.counts.skipped_tests}`;

            var td4 = document.createElement('td');
            td4.setAttribute('class', 'text-center');
            td4.textContent += `${
              data.summary.counts.errored_cases +
              data.summary.counts.skipped_tests
            }`;
            tr.appendChild(td2);
            tr.appendChild(td3);
            tr.appendChild(td4);
            
            tbody.appendChild(tr);
          }

          //summary total
          var summaryErroredCases = document.getElementById(
            "summary-errored_cases"
          );
          summaryErroredCases.textContent = `${data.summary.errored_cases}`;
          var summarySkippedTests = document.getElementById(
            "summary-skipped_tests"
          );
          summarySkippedTests.textContent = `${data.summary.skipped_tests}`;
          var summaryTotalTests = document.getElementById(
            "summary-total-tests"
          );
          summaryTotalTests.textContent = `${
            data.summary.errored_cases + data.summary.skipped_tests
          }`;
        });

      //setting datetime attribute

      //changing theme icon
      //moon icon
      var themeSvgMoon = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "svg",
      );
      themeSvgMoon.setAttribute("xmlns", "http://www.w3.org/2000/svg");
      themeSvgMoon.setAttribute("width", "20");
      themeSvgMoon.setAttribute("height", "20");
      themeSvgMoon.setAttribute("fill", "currentColor");
      themeSvgMoon.setAttribute("class", "bi bi-moon-fill");
      themeSvgMoon.setAttribute("viewBox", "0 0 16 16");
      const pathMoon = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "path",
      );
      pathMoon.setAttribute(
        "d",
        "M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z",
      );
      themeSvgMoon.appendChild(pathMoon);

      //Sun Icon
      var themeSvgSun = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "svg",
      );
      themeSvgSun.setAttribute("xmlns", "http://www.w3.org/2000/svg");
      themeSvgSun.setAttribute("width", "20");
      themeSvgSun.setAttribute("height", "20");
      themeSvgSun.setAttribute("fill", "currentColor");
      themeSvgSun.setAttribute("class", "bi bi-sun");
      themeSvgSun.setAttribute("viewBox", "0 0 16 16");

      const pathSun = document.createElementNS(
        "http://www.w3.org/2000/svg",
        "path",
      );
      pathSun.setAttribute(
        "d",
        "M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z",
      );
      themeSvgSun.appendChild(pathSun);

      dark
        ? themeTogglerButton.appendChild(themeSvgMoon)
        : themeTogglerButton.appendChild(themeSvgSun);

      //adding dark theme
      const body = document.querySelector("body");
      body.setAttribute("data-bs-theme", dark ? "dark" : "light");

      themeTogglerButton.addEventListener("click", () => {
        body.setAttribute("data-bs-theme", dark ? "light" : "dark");
        dark = !dark;

        dark
          ? (themeTogglerButton.appendChild(themeSvgMoon),
            themeTogglerButton.removeChild(themeSvgSun))
          : (themeTogglerButton.appendChild(themeSvgSun),
            themeTogglerButton.removeChild(themeSvgMoon));
      });
    </script>
  </body>
</html>
